{{ $page := .root }}
{{ $section := .page }}

<div class="universal-wrapper pt-3">
    <h1>{{ $section.Params.title }}</h1>
</div>

<style>
    .fb-feed-row {
        margin: 30px -15px !important;
    }

    .pagination-container {
        margin-top: 50px;
    }

    .pagination .page-item.active .page-link {
        background-color: #007bff;
        color: white;
        border-color: #007bff;
    }

    .pagination .page-item .page-link {
        color: #007bff;
        cursor: pointer;
    }

    .pagination .page-item .page-link:hover {
        background-color: #0056b3;
        color: white;
    }

    .debug-container {
        background: #f8f9fa;
        border: 1px solid #ccc;
        padding: 10px;
        margin: 20px 0;
        font-size: 14px;
        color: #333;
        max-height: 300px;
        overflow-y: auto;
    }
</style>

<!-- Debug Output -->
<div class="debug-container">
    <h3>Debug Output</h3>
    <div id="debug-output"></div>
</div>

<!-- Facebook Feed -->
<div id="fb-post-container"></div>

<div class="pagination-container d-flex justify-content-center">
    <nav aria-label="Page navigation">
        <ul class="pagination" id="pagination"></ul>
    </nav>
</div>

<script>
    window.currentPage = 1;
    const itemsPerPage = 10;
    let fbFeedData = [];

    function logDebug(message, data = null) {
        const debugOutput = document.getElementById("debug-output");
        let logMessage = `<p><strong>${message}</strong></p>`;
        if (data) {
            logMessage += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
        }
        debugOutput.innerHTML += logMessage;
        console.log(message, data);
    }

    function readyCall() {
        logDebug("üöÄ Fetching fbFeed.json...");

        fetch("/files/fbFeed.json")
            .then(response => {
                if (!response.ok) {
                    throw new Error(`‚ùå Failed to fetch JSON. Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                logDebug("‚úÖ JSON Data Loaded:", data);

                // Fix JSON structure if needed
                fbFeedData = Array.isArray(data) ? data : data.data || [];

                if (!fbFeedData.length) {
                    logDebug("‚ö†Ô∏è No Facebook data available.");
                    document.getElementById("fb-post-container").innerHTML = "<p>No posts available.</p>";
                    return;
                }

                window.totalItems = fbFeedData.length;
                window.totalPages = Math.ceil(window.totalItems / itemsPerPage);
                logDebug(`üìÑ Total posts: ${window.totalItems}, Total pages: ${window.totalPages}`);

                updateFeed();
                createPagination();
            })
            .catch(error => logDebug("‚ùå Error loading FB feed:", error));
    }

    function updateFeed() {
    logDebug(`üîÑ Rendering page ${window.currentPage}...`);

    if (!fbFeedData.length) return;

    let start = (window.currentPage - 1) * itemsPerPage;
    let end = Math.min(start + itemsPerPage, fbFeedData.length);
    let pageData = fbFeedData.slice(start, end);

    // ‚úÖ CLEAR OLD POSTS before adding new ones
    let fbPostContainer = document.getElementById("fb-post-container");
    fbPostContainer.innerHTML = ""; 

    let HTMLData = '<div class="container"><div class="row fb-feed-row">';
    pageData.forEach((post, index) => {
        HTMLData += `<div class="col-md-6">
                        <div class="fb-post" data-href="${post}" data-width="700"></div>
                    </div>`;
        if (index % 2 !== 0) HTMLData += `</div><div class="row fb-feed-row">`;
    });

    HTMLData += '</div></div>';
    fbPostContainer.innerHTML = HTMLData; // ‚úÖ Insert new posts

    logDebug("‚úÖ Feed updated successfully. New posts displayed.");

    // ‚úÖ Ensure Facebook SDK parses new content
    setTimeout(() => {
        if (typeof FB !== "undefined" && FB.XFBML && typeof FB.XFBML.parse === "function") {
            logDebug("üîÑ Re-parsing Facebook posts for new page...");
            FB.XFBML.parse();
        } else {
            logDebug("‚ùå Facebook SDK not loaded.");
        }
    }, 500);
}
function createPagination() {
    logDebug("üìå Creating pagination...");
    
    let root = document.getElementById("pagination");
    root.innerHTML = "";

    // Previous button
    let prevElem = document.createElement("li");
    prevElem.classList.add("page-item");
    if (window.currentPage === 1) prevElem.classList.add("disabled");
    let prevAnchor = document.createElement("a");
    prevAnchor.classList.add("page-link");
    prevAnchor.innerHTML = "Previous";
    prevAnchor.href = "#";  // ‚úÖ Prevents page reload
    prevAnchor.onclick = (event) => {
        event.preventDefault();  // ‚úÖ Stops browser from refreshing
        changePage(window.currentPage - 1);
    };
    prevElem.append(prevAnchor);
    root.append(prevElem);

    // Page numbers
    for (let i = 1; i <= window.totalPages; i++) {
        let pageElem = document.createElement("li");
        pageElem.classList.add("page-item");
        if (i === window.currentPage) pageElem.classList.add("active");
        let pageAnchor = document.createElement("a");
        pageAnchor.classList.add("page-link");
        pageAnchor.innerHTML = i;
        pageAnchor.href = "#";  // ‚úÖ Prevents page reload
        pageAnchor.onclick = (event) => {
            event.preventDefault();  // ‚úÖ Stops browser from refreshing
            changePage(i);
        };
        pageElem.append(pageAnchor);
        root.append(pageElem);
    }

    // Next button
    let nextElem = document.createElement("li");
    nextElem.classList.add("page-item");
    if (window.currentPage === window.totalPages) nextElem.classList.add("disabled");
    let nextAnchor = document.createElement("a");
    nextAnchor.classList.add("page-link");
    nextAnchor.innerHTML = "Next";
    nextAnchor.href = "#";  // ‚úÖ Prevents page reload
    nextAnchor.onclick = (event) => {
        event.preventDefault();  // ‚úÖ Stops browser from refreshing
        changePage(window.currentPage + 1);
    };
    nextElem.append(nextAnchor);
    root.append(nextElem);

    logDebug("‚úÖ Pagination updated for page " + window.currentPage);
}


    function changePage(newPage) {
        if (newPage < 1 || newPage > window.totalPages) return;
        
        logDebug(`üìÑ Changing to page ${newPage}...`);
        
        window.currentPage = newPage;
        
        updateFeed(); // ‚úÖ Refreshes the posts on the page
        createPagination(); // ‚úÖ Re-creates pagination to highlight active page

        // ‚úÖ Ensure Facebook SDK re-parses the new posts
        setTimeout(() => {
            if (typeof FB !== "undefined" && FB.XFBML && typeof FB.XFBML.parse === "function") {
                logDebug("üîÑ Re-parsing Facebook posts for new page...");
                FB.XFBML.parse();
            } else {
                logDebug("‚ùå Facebook SDK not loaded.");
            }
        }, 500);
    }

    document.addEventListener("DOMContentLoaded", readyCall);
</script>

<script async defer src="https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v3.2"></script>
